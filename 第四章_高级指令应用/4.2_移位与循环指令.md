# 4.2 移位与循环指令

> 本节将介绍PLC的移位和循环操作指令

## 学习目标

- 掌握移位指令的类型和用法
- 理解逻辑移位与算术移位的区别
- 能够灵活运用移位指令

---

## 1. 移位指令概述

### 1.1 什么是移位操作

移位操作是将数据的所有位向左或向右移动指定位数的操作。

```
移位操作示意图：

原始数据：    [1][0][1][1][0][0][1][0]
                ↓  左移2位
移位后：      [1][1][0][0][1][0][0][0]
                      ↑↑
                   补0（左移右侧补0）

原始数据：    [1][0][1][1][0][0][1][0]
                ↓  右移2位
移位后：      [0][0][1][0][1][1][0][0]
               ↑↑
            补0（逻辑右移左侧补0）
```

### 1.2 移位指令分类

```
移位指令类型：

┌─────────────────────────────────────────────────────┐
│                    移位指令                          │
├────────────────┬────────────────┬───────────────────┤
│   逻辑移位      │   算术移位      │   循环移位        │
├────────────────┼────────────────┼───────────────────┤
│ · SHL 逻辑左移 │ · 保留符号位    │ · ROL 循环左移   │
│ · SHR 逻辑右移 │ · 右移时高位    │ · ROR 循环右移   │
│ · 补0          │   补符号位      │ · 移出位回到另端 │
└────────────────┴────────────────┴───────────────────┘
```

### 1.3 各品牌指令对照

| 功能 | 西门子(S7) | 三菱(FX) | 欧姆龙 |
|------|-----------|----------|--------|
| 逻辑左移 | SHL | SFTL | SHL |
| 逻辑右移 | SHR | SFTR | SHR |
| 循环左移 | ROL | - | ROL |
| 循环右移 | ROR | - | ROR |
| 位移位寄存器 | - | SFTR/SFTL | SFT |

---

## 2. 左移指令（SHL）

### 2.1 逻辑左移原理

```
逻辑左移（SHL）原理：

所有位向左移动，右侧补0，左侧移出的位丢弃

示例：左移2位
Before: [1][0][1][1][0][1][0][0] = 0xB4 (180)
         ↓
After:  [1][1][0][1][0][0][0][0] = 0xD0 (208)
         └─┬─┘            ↑↑
         丢弃            补0

数学意义：左移n位 ≈ 乘以2ⁿ
180 × 4 = 720（但结果溢出，实际为208）
```

### 2.2 西门子SHL指令

```
【梯形图】
              ┌──────────┐
   I0.0 ─────┤   SHL    │
              │          │
   MW10 ─────┤IN    OUT ├───── MW20
       2 ────┤N         │
              └──────────┘

【SCL程序】
MW20 := SHL(IN := MW10, N := 2);

// 或使用运算符
MW20 := MW10 SHL 2;

【数据类型】
SHL_W  : 16位字左移
SHL_DW : 32位双字左移
```

### 2.3 三菱左移指令

```
三菱位元件移位（SFTL）：

【梯形图】
       X0                M0    M10   K4    K8
    ───┤├───────[SFTL M0 M10 K4 K8]───

【参数说明】
· M0：移入数据源（K4个位）
· M10：移位区起始
· K4：每次移位位数
· K8：移位区长度

【工作过程】
移位前：M10-M17 = 00001111
X0脉冲后：
· M10-M13的值移出（丢弃或移到M14-M17）
· M0-M3的值移入M10-M13
```

---

## 3. 右移指令（SHR）

### 3.1 逻辑右移原理

```
逻辑右移（SHR）原理：

所有位向右移动，左侧补0，右侧移出的位丢弃

示例：右移2位
Before: [1][0][1][1][0][1][0][0] = 0xB4 (180)
         ↓
After:  [0][0][1][0][1][1][0][1] = 0x2D (45)
        ↑↑            └─┬─┘
       补0            丢弃

数学意义：右移n位 ≈ 除以2ⁿ
180 ÷ 4 = 45
```

### 3.2 算术右移

```
算术右移（SAR）原理：

右移时保留符号位（最高位）

示例：算术右移2位（有符号数-76）
Before: [1][0][1][1][0][1][0][0] = 0xB4 (-76有符号)
         ↓
After:  [1][1][1][0][1][1][0][1] = 0xED (-19有符号)
        ↑↑              └─┬─┘
      补符号位          丢弃

数学意义：-76 ÷ 4 = -19
保持负数特性
```

### 3.3 西门子SHR指令

```
【梯形图】
              ┌──────────┐
   I0.0 ─────┤   SHR    │
              │          │
   MW10 ─────┤IN    OUT ├───── MW20
       3 ────┤N         │
              └──────────┘

【SCL程序】
MW20 := SHR(IN := MW10, N := 3);

// 或使用运算符
MW20 := MW10 SHR 3;

【数据类型】
SHR_W  : 16位字右移（逻辑）
SHR_DW : 32位双字右移
```

### 3.4 三菱右移指令

```
三菱位元件移位（SFTR）：

【梯形图】
       X0                M0    M10   K4    K8
    ───┤├───────[SFTR M0 M10 K4 K8]───

【参数说明】
· M0：移入数据源
· M10：移位区起始
· K4：每次移位位数
· K8：移位区长度

【工作过程】
移位区向右移动，左侧移入新数据
```

---

## 4. 循环移位指令（ROL/ROR）

### 4.1 循环左移（ROL）

```
循环左移原理：

左侧移出的位回到右侧，形成循环

示例：循环左移2位
Before: [1][0][1][1][0][1][0][0]
         ↓
After:  [1][1][0][1][0][0][1][0]
                          ↑↑
                    从左侧移出的位

移出的[1][0]回到了右侧
```

### 4.2 循环右移（ROR）

```
循环右移原理：

右侧移出的位回到左侧，形成循环

示例：循环右移3位
Before: [1][0][1][1][0][1][0][0]
         ↓
After:  [1][0][0][1][0][1][1][0]
        ↑↑↑
   从右侧移出的[1][0][0]

移出的位回到了左侧
```

### 4.3 西门子循环移位

```
【梯形图】
              ┌──────────┐
   I0.0 ─────┤   ROL    │
              │          │
   MW10 ─────┤IN    OUT ├───── MW20
       4 ────┤N         │
              └──────────┘

【SCL程序】
// 循环左移
MW20 := ROL(IN := MW10, N := 4);

// 循环右移
MW20 := ROR(IN := MW10, N := 4);

【特点】
· 不丢失任何位
· 适合位图循环显示
· 适合密钥轮换等应用
```

---

## 5. 字移位指令

### 5.1 三菱字移位（WSFR/WSFL）

```
字右移（WSFR）：

       X0
    ───┤├───────[WSFR D0 D10 K5]───

· D0：移入数据
· D10：移位区起始
· K5：移位区长度（字数）

工作原理：
Before: D10=A, D11=B, D12=C, D13=D, D14=E
移位后: D10=D0, D11=A, D12=B, D13=C, D14=D
                           E被移出丢弃
```

### 5.2 FIFO/LIFO操作

```
FIFO（先进先出）队列：

三菱指令：
SFRD [S] [D] [n]   // 从队列读出（出队）
SFWR [S] [D] [n]   // 写入队列（入队）

示例：
       X0
    ───┤├───────[SFWR D0 D100 K10]───  // D0入队到D100区

       X1
    ───┤├───────[SFRD D100 D200 K10]── // 从D100区出队到D200

队列结构（D100区域）：
D100 = 当前元素个数
D101-D110 = 数据区
```

---

## 6. 移位寄存器应用

### 6.1 步进控制

```
移位寄存器实现步进控制：

需求：控制8个工位依次动作

       X0                M10   K1    K8
    ───┤P├──────[SFTL K1 M10 K1 K8]───

· 每次X0脉冲，M10-M17中的1向左移动一位
· M10=1→M11=1→M12=1→...→M17=1

输出控制：
       M10
    ───┤├───────( Y0 )───   // 工位1

       M11
    ───┤├───────( Y1 )───   // 工位2
    ...
       M17
    ───┤├───────( Y7 )───   // 工位8
```

### 6.2 产品跟踪

```
应用：传送带产品跟踪

传感器检测产品，跟踪产品在传送带上的位置

       X0                M100  M200  K1    K20
    ───┤├───────[SFTL M100 M200 K1 K20]───

· X0：传送带节拍脉冲（如编码器脉冲）
· M100：入口检测（有产品=1）
· M200-M219：跟踪区域（20个位置）

当M210=1时，表示产品到达位置10
       M210
    ───┤├───────( Y10 )───  // 位置10动作
```

### 6.3 流水灯效果

```
流水灯程序：

方法1：循环移位

       M8013              MW10   K1
    ───┤├───────[ROL MW10 K1 MW10]───

       SM400
    ───┤├───────[MOV MW10 K2Y0]───

· M8013：1秒时钟脉冲
· MW10初始值=1
· 每秒循环左移1位
· 输出到Y0-Y17（16个灯）

方法2：表格循环
       M8013
    ───┤P├──────[INC D0]───
               [> D0 K7]────[MOV K0 D0]───

       D0             K1    D10
    ───┤├───────[SHL K1 D0 D10]───
               [MOV D10 K2Y0]───
```

---

## 7. 移位运算技巧

### 7.1 乘除法替代

```
用移位代替乘除法（效率更高）：

乘法：
· X × 2  = X SHL 1
· X × 4  = X SHL 2
· X × 8  = X SHL 3
· X × 2ⁿ = X SHL n

除法：
· X ÷ 2  = X SHR 1
· X ÷ 4  = X SHR 2
· X ÷ 8  = X SHR 3
· X ÷ 2ⁿ = X SHR n

示例：X × 10 = X × 8 + X × 2 = (X SHL 3) + (X SHL 1)
```

### 7.2 位提取

```
提取特定位：

提取第n位的值：
Result = (Data SHR n) AND 1

示例：提取D0第5位
       SM400
    ───┤├───────[SHR D0 K5 D10]───
               [AND D10 K1 D20]───

D20 = D0的第5位值（0或1）
```

### 7.3 位设置/清除

```
设置特定位为1：
Data = Data OR (1 SHL n)

清除特定位为0：
Data = Data AND (NOT (1 SHL n))

翻转特定位：
Data = Data XOR (1 SHL n)

示例：设置D0第3位为1
       SM400
    ───┤├───────[SHL K1 K3 D10]───    // D10 = 0x08
               [OR D0 D10 D0]───      // D0第3位置1
```

---

## 8. 应用实例

### 8.1 信号灯循环控制

```
需求：8个信号灯循环点亮

程序：
// 初始化
       SM8002                         // 首次扫描
    ───┤├───────[MOV K1 D0]───       // D0 = 0x0001

// 定时移位
       T0
    ───┤├───────[ROL D0 K1 D0]───    // 循环左移

// 定时器（500ms）
       SM400         T0          K5
    ───┤├─────────┤/├─────[OUT T0]───

// 输出
       SM400
    ───┤├───────[MOV D0 K2Y0]───     // 输出到Y0-Y15

效果：Y0→Y1→Y2→...→Y7→Y0 循环
```

### 8.2 数据加密（简单异或+移位）

```
简单加密算法：

加密：
1. 与密钥异或
2. 循环左移3位

解密：
1. 循环右移3位
2. 与密钥异或

程序（加密）：
       X0
    ───┤├───────[XOR D0 K12345 D10]───  // 异或
               [ROL D10 K3 D10]───       // 循环左移

程序（解密）：
       X1
    ───┤├───────[ROR D10 K3 D10]───      // 循环右移
               [XOR D10 K12345 D0]───    // 异或还原
```

### 8.3 条形码扫描

```
移位寄存器接收串行数据：

       X0                              // 数据输入
    ───┤├───────[MOV X0 M100]───

       X1                              // 时钟脉冲
    ───┤P├──────[SFTL M100 M0 K1 K16]──

每个时钟脉冲：
· 读取X0状态到M100
· M0-M15左移1位
· M100移入M0

16个脉冲后，M0-M15存储16位串行数据
```

---

## 本节小结

```
移位指令要点：

┌────────────────────────────────────────────────────┐
│  逻辑移位                                          │
│  · SHL左移：右侧补0                               │
│  · SHR右移：左侧补0                               │
│  · 移出的位丢弃                                   │
├────────────────────────────────────────────────────┤
│  算术移位                                          │
│  · 右移时保留符号位                               │
│  · 用于有符号数除法                               │
├────────────────────────────────────────────────────┤
│  循环移位                                          │
│  · ROL/ROR：移出位回到另一端                      │
│  · 不丢失数据，适合循环显示                       │
├────────────────────────────────────────────────────┤
│  应用技巧                                          │
│  · 移位代替乘除（×2ⁿ/÷2ⁿ）                       │
│  · 位提取/设置/清除                               │
│  · 步进控制、产品跟踪                             │
└────────────────────────────────────────────────────┘
```

---

## 练习题

1. 说明逻辑右移和算术右移的区别。
2. 编写程序实现8个LED灯的流水效果。
3. 如何用移位指令实现乘以10的运算？
4. 设计一个移位寄存器实现5工位步进控制。

---

[← 上一节：4.1 数学运算指令](./4.1_数学运算指令.md) | [返回目录](../README.md) | [下一节：4.3 程序控制指令 →](./4.3_程序控制指令.md)
