# 3.4 数据传送指令

> 本节将介绍PLC数据传送和移动指令

## 学习目标

- 掌握数据传送指令的用法
- 理解块传送的概念
- 能够实现数据的灵活传送

---

## 1. 数据传送概述

### 1.1 什么是数据传送

数据传送指令用于在PLC内部不同存储区域之间移动或复制数据。

```
数据传送基本概念：

┌─────────────┐          ┌─────────────┐
│   源数据    │ ───────→ │  目标地址   │
│   (源)      │   传送   │   (目标)    │
└─────────────┘          └─────────────┘

说明：
· 源数据可以是常数或地址
· 目标必须是地址
· 传送后源数据不变（复制操作）
```

### 1.2 数据传送分类

```
数据传送指令类型：

┌─────────────────────────────────────────────────────┐
│                  数据传送指令                       │
├────────────┬────────────┬────────────┬──────────────┤
│   MOV      │  BLKMOV    │   FILL     │    SWAP     │
│  单数据    │  块传送    │   填充     │    交换     │
├────────────┼────────────┼────────────┼──────────────┤
│ 传送一个值 │ 传送多个值 │ 用同一值   │ 高低字节    │
│ 到一个地址 │ 到连续地址 │ 填充区域   │ 交换        │
└────────────┴────────────┴────────────┴──────────────┘
```

### 1.3 各品牌指令对照

| 功能 | 西门子(S7) | 三菱(FX) | 欧姆龙 |
|------|-----------|----------|--------|
| 单数据传送 | MOVE | MOV | MOV |
| 块传送 | BLKMOV | BMOV | XFER |
| 填充 | FILL | FMOV | BSET |
| 交换 | SWAP | SWAP | XCHG |

---

## 2. 单数据传送（MOVE/MOV）

### 2.1 功能说明

将源操作数的值传送到目标地址，是最基本的数据传送指令。

```
MOVE指令原理：

执行前：               执行后：
┌───────┐             ┌───────┐
│ 源:100│   传送      │ 源:100│  ← 源不变
└───────┘   ───→      └───────┘
                      
┌───────┐             ┌───────┐
│目标:0 │             │目标:100│ ← 目标更新
└───────┘             └───────┘
```

### 2.2 西门子MOVE指令

```
【梯形图】
              ┌──────────┐
   I0.0 ─────┤   MOVE   │
              │          │
     100 ────┤IN     OUT├───── MW10
              └──────────┘

【SCL程序】
IF I0.0 THEN
    MW10 := 100;
END_IF;

【STL程序】
LD    I0.0
MOVE  100, MW10

【说明】
· IN：源操作数（常数或地址）
· OUT：目标地址
· 当I0.0=1时执行传送
```

### 2.3 三菱MOV指令

```
【梯形图】
       X0          K100      D0
    ───┤├───────[MOV K100 D0]───

【指令格式】
MOV  [S]  [D]
· S：源操作数
· D：目标地址

【数据类型】
┌────────────────────────────────────────────────────┐
│  MOV   │ 16位数据传送（-32768~32767）            │
│  DMOV  │ 32位数据传送（双字）                    │
└────────────────────────────────────────────────────┘

【示例】
MOV  K100  D0      // 常数100传送到D0
MOV  D10   D20     // D10的值传送到D20
DMOV K100000 D100  // 32位常数传送到D100/D101
```

### 2.4 间接寻址传送

```
利用变量作为地址偏移：

西门子（间接寻址）：
// MW[DB1.DBW0]：用DB1.DBW0的值作为地址偏移
MOVE  100, MW[DB1.DBW0]

三菱（变址寻址）：
MOV  K100  D0Z0    // 传送到D(0+Z0)
                   // 若Z0=5，则传送到D5

应用场景：
· 数组操作
· 批量数据处理
· 配方切换
```

---

## 3. 块数据传送（BLKMOV/BMOV）

### 3.1 功能说明

一次性传送多个连续数据到另一个连续区域。

```
块传送原理：

源区域：           目标区域：
┌───┐              ┌───┐
│D0 │ ──────────→ │D100│
├───┤              ├───┤
│D1 │ ──────────→ │D101│
├───┤              ├───┤
│D2 │ ──────────→ │D102│
├───┤              ├───┤
│D3 │ ──────────→ │D103│
└───┘              └───┘
  ↑                  ↑
源起始地址        目标起始地址
     └── 传送数量:4 ──┘
```

### 3.2 西门子BLKMOV指令

```
【梯形图】
               ┌──────────┐
   I0.0 ──────┤ BLKMOV   │
               │          │
   P#DB1.DBX0.0────┤SRCBLK    │
   BYTE 10     │          │
               │          │
   P#DB2.DBX0.0────┤DSTBLK    │
   BYTE 10     │          │
               └──────────┘

【SCL程序】
// 使用系统函数
BLKMOV(SRCBLK := P#DB1.DBX0.0 BYTE 10,
       DSTBLK := P#DB2.DBX0.0 BYTE 10);

【说明】
· SRCBLK：源数据块
· DSTBLK：目标数据块
· 可指定起始地址和数量
```

### 3.3 三菱BMOV指令

```
【梯形图】
       X0
    ───┤├───────[BMOV D0 D100 K10]───

【指令格式】
BMOV  [S]  [D]  [n]
· S：源起始地址
· D：目标起始地址
· n：传送点数

【示例】
BMOV  D0   D100  K10   // D0-D9 → D100-D109
BMOV  K4X0 D0    K2    // X0-X7,X10-X17 → D0,D1

【注意事项】
· 源和目标区域不能重叠
· n的范围：1~512
```

### 3.4 重叠区域处理

```
当源和目标区域重叠时：

情况1：目标在源后面（正向传送）
D0-D3 → D2-D5  ❌ 可能出错

正确方法：从高地址向低地址传送
或使用专用指令


情况2：使用临时区域
D0-D3 → 临时区 → D2-D5  ✓ 安全
```

---

## 4. 填充指令（FILL/FMOV）

### 4.1 功能说明

用同一个值填充一段连续的存储区域。

```
填充指令原理：

填充值: 0           目标区域：
                   ┌───┐
  0 ──────────────→│D100│ = 0
  │                ├───┤
  ├──────────────→│D101│ = 0
  │                ├───┤
  ├──────────────→│D102│ = 0
  │                ├───┤
  └──────────────→│D103│ = 0
                   └───┘
```

### 4.2 西门子FILL指令

```
【梯形图】
               ┌──────────┐
   I0.0 ──────┤  FILL    │
               │          │
       0 ─────┤IN        │
               │          │
   P#MW100 ───┤OUT       │
   WORD 10    │          │
               └──────────┘

【SCL程序】
// 循环填充
FOR i := 0 TO 9 DO
    MW[100 + i*2] := 0;
END_FOR;
```

### 4.3 三菱FMOV指令

```
【梯形图】
       X0
    ───┤├───────[FMOV K0 D100 K10]───

【指令格式】
FMOV  [S]  [D]  [n]
· S：填充值
· D：目标起始地址
· n：填充点数

【示例】
FMOV  K0    D100  K100   // D100-D199全部清零
FMOV  K9999 D0    K50    // D0-D49全部填9999

【应用场景】
· 数据区清零
· 初始化参数
· 设置默认值
```

---

## 5. 交换指令（SWAP/XCHG）

### 5.1 字节交换（SWAP）

交换一个字（16位）的高低字节。

```
SWAP指令原理：

交换前：              交换后：
┌────────────────┐   ┌────────────────┐
│ 高字节 │ 低字节 │   │ 低字节 │ 高字节 │
│  12H   │  34H   │ → │  34H   │  12H   │
└────────────────┘   └────────────────┘
    MW10 = 1234H         MW10 = 3412H
```

### 5.2 数据交换（XCHG）

交换两个地址的内容。

```
XCHG指令原理：

交换前：           交换后：
┌───────┐         ┌───────┐
│D0: 100│         │D0: 200│
└───────┘  交换   └───────┘
    ↕      ←→        ↕
┌───────┐         ┌───────┐
│D10:200│         │D10:100│
└───────┘         └───────┘
```

### 5.3 三菱XCH指令

```
【梯形图】
       X0
    ───┤├───────[XCH D0 D10]───

【指令格式】
XCH  [D1]  [D2]
· D1、D2：交换的两个地址

【示例】
XCH   D0   D10     // 16位数据交换
DXCH  D0   D10     // 32位数据交换
```

---

## 6. 其他传送指令

### 6.1 条件传送

```
带条件的数据传送：

西门子（SEL 选择）：
               ┌──────────┐
       G ─────┤   SEL    │
               │          │
     IN0 ─────┤          ├── OUT
     IN1 ─────┤          │
               └──────────┘

当G=0时，OUT=IN0
当G=1时，OUT=IN1


三菱（CML 取反传送）：
       X0
    ───┤├───────[CML D0 D10]───

D0按位取反后传送到D10
```

### 6.2 移位传送

```
移位寄存器功能：

三菱SFTR指令（右移）：
       X0
    ───┤├───────[SFTR M0 M10 K4 K8]───

· M0：输入数据
· M10：移位起始地址
· K4：每次移位位数
· K8：移位总长度

工作原理：
移位前：M10-M17 = 0000 1111
移位后：M10-M17 = 0011 1100  （右移4位，M0的4位移入）
```

### 6.3 表格操作

```
三菱表格指令：

FIFO（先进先出）：
SFRD  [S]  [D]  [n]   // 从表格读出
SFWR  [S]  [D]  [n]   // 写入表格

LIFO（后进先出）：
POP   [S]  [D]  [n]   // 出栈
PUSH  [S]  [D]  [n]   // 压栈
```

---

## 7. 数据传送应用实例

### 7.1 配方切换

```
需求：根据选择切换不同配方参数

配方存储：
· 配方1：D100-D109
· 配方2：D110-D119
· 配方3：D120-D129
· 当前配方：D0-D9

程序：
// 选择配方1
       X0
    ───┤├───────[BMOV D100 D0 K10]───

// 选择配方2
       X1
    ───┤├───────[BMOV D110 D0 K10]───

// 选择配方3
       X2
    ───┤├───────[BMOV D120 D0 K10]───

工作流程：
按下X0 → D100-D109复制到D0-D9
按下X1 → D110-D119复制到D0-D9
按下X2 → D120-D129复制到D0-D9
```

### 7.2 数据保存与恢复

```
需求：保存当前参数到备份区，可恢复

保存（X10触发）：
       X10
    ───┤├───────[BMOV D0 D500 K50]───
                         ↑
                    备份区域

恢复（X11触发）：
       X11
    ───┤├───────[BMOV D500 D0 K50]───
                         ↑
                    从备份恢复
```

### 7.3 数据初始化

```
需求：系统启动时初始化数据区

// 首次扫描标志
       M8002                         // 三菱：首次扫描ON
    ───┤├───────[FMOV K0 D0 K100]─── // D0-D99清零
               [FMOV K0 M0 K256]───  // M0-M255清零
               [MOV K100 D100]───    // 设置默认速度
               [MOV K50 D101]───     // 设置默认位置

// 西门子：使用OB100（启动OB）
// 或使用首次扫描标志位
```

### 7.4 数据采集记录

```
需求：记录最近10次测量数据

数据移位存储：
       X0
    ───┤P├──────[BMOV D1 D2 K9]───   // D1-D9 → D2-D10（后移）
               [MOV D100 D1]───       // 新数据存入D1

数据结构：
D1  ← 最新数据
D2  ← 上一次
D3  ← 上上次
...
D10 ← 最旧数据

每次X0上升沿：
1. D1-D9向后移动一位
2. 新测量值D100存入D1
3. 最旧的D10被覆盖
```

### 7.5 通信缓冲区

```
发送缓冲区准备：

// 组装发送数据
       M0.0
    ───┤├───────[MOV K255 D200]───    // 帧头
               [MOV D0 D201]───       // 数据1
               [MOV D1 D202]───       // 数据2
               [MOV D2 D203]───       // 数据3
               [MOV K0 D204]───       // 校验

// 或使用块传送
       M0.0
    ───┤├───────[MOV K255 D200]───    // 帧头
               [BMOV D0 D201 K3]───   // 数据区
```

---

## 8. 使用注意事项

### 8.1 数据类型匹配

```
注意数据宽度：

┌────────────────────────────────────────────────────┐
│  错误示例：                                        │
│  MOV D0 M0   ← D0是16位，M0是1位，不匹配         │
│                                                    │
│  正确做法：                                        │
│  MOV D0 K4M0  ← 传送到M0开始的16位区域           │
└────────────────────────────────────────────────────┘

数据类型对应：
· 位(Bit) ↔ 位
· 字节(Byte) ↔ 字节
· 字(Word) ↔ 字
· 双字(DWord) ↔ 双字
```

### 8.2 执行条件

```
传送指令执行时机：

【每次扫描执行】
       SM400                         // 常ON
    ───┤├───────[MOV K100 D0]───    // 每个扫描周期都执行

【条件执行】
       X0
    ───┤├───────[MOV K100 D0]───    // X0=ON时执行

【边沿执行】
       X0
    ───┤P├──────[MOV K100 D0]───    // X0上升沿执行一次

建议：
· 需要持续更新的用条件触发
· 只需执行一次的用边沿触发
```

### 8.3 地址范围检查

```
防止地址越界：

错误示例：
BMOV D0 D32760 K10   // D32760-D32769
                     // 如果D区只到D32767，会越界！

预防措施：
1. 规划好数据区域分配
2. 检查传送范围是否超出
3. 使用符号地址减少错误
```

---

## 本节小结

```
数据传送指令要点：

┌────────────────────────────────────────────────────┐
│  MOV（单数据传送）                                 │
│  · 传送一个数据到目标地址                         │
│  · 最基本最常用的传送指令                         │
│  · 注意16位/32位区别                              │
├────────────────────────────────────────────────────┤
│  BMOV（块传送）                                    │
│  · 一次传送多个连续数据                           │
│  · 效率高于多次MOV                                │
│  · 注意避免源目标重叠                             │
├────────────────────────────────────────────────────┤
│  FMOV（填充）                                      │
│  · 用同一值填充连续区域                           │
│  · 常用于数据初始化/清零                          │
├────────────────────────────────────────────────────┤
│  XCH（交换）                                       │
│  · 交换两个地址的内容                             │
│  · 用于数据排序等场合                             │
└────────────────────────────────────────────────────┘
```

---

## 练习题

1. 编写程序将D0-D9的数据复制到D100-D109。
2. 如何将D0-D49全部清零？
3. 设计一个配方切换程序，有3种配方可选。
4. 说明MOV和BMOV指令的区别及应用场景。

---

[← 上一节：3.3 计数器指令](./3.3.md) | [返回目录](/) | [下一节：3.5 数学运算指令 →](./3.5.md)
