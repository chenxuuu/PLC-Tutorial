# 4.1 数学运算指令

> 本节将介绍PLC的数学运算指令

## 学习目标

- 掌握基本数学运算指令
- 理解数据溢出的处理
- 能够进行复杂的数学计算

---

## 1. 数学运算概述

### 1.1 运算指令分类

```
PLC数学运算指令分类：

┌─────────────────────────────────────────────────────┐
│                   数学运算指令                       │
├────────────┬────────────┬────────────┬──────────────┤
│  基本运算   │  高级运算  │  数学函数  │  类型转换    │
├────────────┼────────────┼────────────┼──────────────┤
│ · ADD加    │ · MOD取模  │ · SIN正弦  │ · INT→REAL  │
│ · SUB减    │ · INC递增  │ · COS余弦  │ · REAL→INT  │
│ · MUL乘    │ · DEC递减  │ · TAN正切  │ · BCD↔BIN   │
│ · DIV除    │ · NEG取反  │ · SQRT平方根│ · 符号转换  │
└────────────┴────────────┴────────────┴──────────────┘
```

### 1.2 数据类型与运算

| 数据类型 | 位数 | 范围 | 运算指令 |
|----------|------|------|----------|
| INT | 16位 | -32768~32767 | ADD, SUB |
| DINT | 32位 | ±21亿 | ADD_DI, SUB_DI |
| REAL | 32位 | 浮点数 | ADD_R, SUB_R |
| UINT | 16位 | 0~65535 | 无符号运算 |

---

## 2. 加法指令（ADD）

### 2.1 基本概念

加法指令：将两个数相加，结果存入目标地址。

```
加法运算：

   ┌───────┐
   │ 加数1 │─────┐
   └───────┘     │    ┌───────┐
                 ├───→│  结果  │
   ┌───────┐     │    └───────┘
   │ 加数2 │─────┘
   └───────┘

公式：结果 = 加数1 + 加数2
```

### 2.2 西门子ADD指令

```
【梯形图】
              ┌──────────┐
   I0.0 ─────┤   ADD    │
              │          │
   MW10 ─────┤IN1   OUT ├───── MW20
   MW12 ─────┤IN2       │
              └──────────┘

【SCL程序】
MW20 := MW10 + MW12;

【STL程序】
L     MW10
L     MW12
+I              // 整数加法
T     MW20

【数据类型】
ADD_I   : 整数加法（16位）
ADD_DI  : 双整数加法（32位）
ADD_R   : 实数加法（浮点）
```

### 2.3 三菱ADD指令

```
【梯形图】
       X0
    ───┤├───────[ADD D0 D10 D20]───

【指令格式】
ADD  [S1]  [S2]  [D]
· S1：加数1
· S2：加数2
· D：结果存储地址

【示例】
ADD  D0   D10  D20    // D20 = D0 + D10
ADD  K100 D0   D10    // D10 = 100 + D0
DADD D0   D10  D20    // 32位加法

【连续加法】
ADD  D0   D10  D10    // D10 = D0 + D10（累加）
```

### 2.4 溢出处理

```
加法溢出示例：

16位整数加法：
D0 = 30000
D10 = 10000
───────────────
D20 = 30000 + 10000 = 40000

但16位有符号整数最大值为32767
结果溢出！D20 = -25536（错误值）

【解决方法】
1. 使用32位运算（DADD）
2. 先判断是否会溢出
3. 使用浮点数运算

【溢出标志】
西门子：OV（溢出标志）
三菱：M8021（进位标志）
```

---

## 3. 减法指令（SUB）

### 3.1 西门子SUB指令

```
【梯形图】
              ┌──────────┐
   I0.0 ─────┤   SUB    │
              │          │
   MW10 ─────┤IN1   OUT ├───── MW20
   MW12 ─────┤IN2       │
              └──────────┘

【SCL程序】
MW20 := MW10 - MW12;

【数据类型】
SUB_I   : 整数减法
SUB_DI  : 双整数减法
SUB_R   : 实数减法
```

### 3.2 三菱SUB指令

```
【梯形图】
       X0
    ───┤├───────[SUB D0 D10 D20]───

【指令格式】
SUB  [S1]  [S2]  [D]
· D = S1 - S2

【示例】
SUB  D0   D10  D20    // D20 = D0 - D10
SUB  K100 D0   D10    // D10 = 100 - D0
DSUB D0   D10  D20    // 32位减法
```

---

## 4. 乘法指令（MUL）

### 4.1 乘法特点

```
乘法运算注意事项：

16位 × 16位 = 可能需要32位结果

示例：
  30000 × 3 = 90000（超过16位范围）

因此乘法通常：
· 输入：16位
· 输出：32位（占用连续两个字）

三菱：
D0 × D10 → (D21,D20)
         高16位  低16位
```

### 4.2 西门子MUL指令

```
【梯形图】
              ┌──────────┐
   I0.0 ─────┤   MUL    │
              │          │
   MW10 ─────┤IN1   OUT ├───── MD20
   MW12 ─────┤IN2       │
              └──────────┘

【SCL程序】
MD20 := MW10 * MW12;  // 结果用双整数

【数据类型】
MUL_I   : 整数乘法
MUL_DI  : 双整数乘法
MUL_R   : 实数乘法
```

### 4.3 三菱MUL指令

```
【梯形图】
       X0
    ───┤├───────[MUL D0 D10 D20]───

【16位乘法】
MUL  D0  D10  D20
· D0 × D10 → (D21,D20)
· 结果为32位，存储在D20和D21

【32位乘法】
DMUL D0  D10  D20
· (D1,D0) × (D11,D10) → (D23,D22,D21,D20)
· 结果为64位
```

---

## 5. 除法指令（DIV）

### 5.1 除法特点

```
除法运算结果：

被除数 ÷ 除数 = 商 ... 余数

示例：
17 ÷ 5 = 3 ... 2
    商=3，余数=2

三菱DIV指令结果存储：
D20 = 商
D21 = 余数
```

### 5.2 西门子DIV指令

```
【梯形图】
              ┌──────────┐
   I0.0 ─────┤   DIV    │
              │          │
   MW10 ─────┤IN1   OUT ├───── MW20
   MW12 ─────┤IN2       │
              └──────────┘

【SCL程序】
MW20 := MW10 / MW12;  // 商
MW22 := MW10 MOD MW12;  // 余数

【数据类型】
DIV_I   : 整数除法
DIV_DI  : 双整数除法
DIV_R   : 实数除法
```

### 5.3 三菱DIV指令

```
【梯形图】
       X0
    ───┤├───────[DIV D0 D10 D20]───

【指令格式】
DIV  [S1]  [S2]  [D]
· D = S1 ÷ S2 的商
· D+1 = 余数

【示例】
DIV  K17  K5  D20
· D20 = 3（商）
· D21 = 2（余数）

【除零保护】
       X0         [D10<>K0]
    ───┤├───────────┤├───────[DIV D0 D10 D20]───

必须检查除数不为零！
```

### 5.4 除零错误处理

```
除零错误处理：

【错误】
DIV  D0  K0  D20    // 除数为0，运行错误！

【正确做法】
// 先检查除数
       SM400        D10         K0
    ───┤├───────[<> D10 K0]────[DIV D0 D10 D20]───

// 或使用条件判断
IF D10 <> 0 THEN
    D20 := D0 / D10;
ELSE
    D20 := 0;  // 或设置错误标志
END_IF;
```

---

## 6. 取模运算（MOD）

### 6.1 取模概念

```
取模运算：求除法的余数

示例：
17 MOD 5 = 2（17÷5=3...2）
10 MOD 3 = 1（10÷3=3...1）
8 MOD 4 = 0（8÷4=2...0，整除）

应用场景：
· 判断奇偶：N MOD 2（0为偶，1为奇）
· 循环计数：N MOD 10（0-9循环）
· 周期判断
```

### 6.2 西门子MOD指令

```
【SCL程序】
Remainder := Dividend MOD Divisor;

【示例】
// 判断奇偶
IF (Counter MOD 2) = 0 THEN
    // 偶数
ELSE
    // 奇数
END_IF;
```

### 6.3 三菱取余

```
三菱使用DIV指令获取余数：

       X0
    ───┤├───────[DIV D0 D10 D20]───

D21中存储的就是余数

【提取余数】
MOV  D21  D100   // 将余数存入D100
```

---

## 7. 递增与递减指令

### 7.1 递增指令（INC）

```
递增：将指定地址的值加1

西门子：
              ┌──────────┐
   I0.0 ─────┤   INC    │
              │          │
   MW10 ─────┤IN/OUT    │
              └──────────┘

三菱：
       X0
    ───┤├───────[INC D0]───

效果：D0 = D0 + 1
```

### 7.2 递减指令（DEC）

```
递减：将指定地址的值减1

西门子：
              ┌──────────┐
   I0.0 ─────┤   DEC    │
              │          │
   MW10 ─────┤IN/OUT    │
              └──────────┘

三菱：
       X0
    ───┤├───────[DEC D0]───

效果：D0 = D0 - 1
```

---

## 8. 三角函数与数学函数

### 8.1 常用数学函数

| 函数 | 功能 | 西门子 | 输入单位 |
|------|------|--------|----------|
| SIN | 正弦 | SIN | 弧度 |
| COS | 余弦 | COS | 弧度 |
| TAN | 正切 | TAN | 弧度 |
| ASIN | 反正弦 | ASIN | - |
| SQRT | 平方根 | SQRT | - |
| LN | 自然对数 | LN | - |
| EXP | e的幂 | EXP | - |
| ABS | 绝对值 | ABS | - |

### 8.2 西门子数学函数

```
【梯形图】
              ┌──────────┐
   I0.0 ─────┤   SIN    │
              │          │
   MD10 ─────┤IN    OUT ├───── MD20
              └──────────┘

【SCL程序】
// 三角函数（输入为弧度）
Result := SIN(Angle);     // 正弦
Result := COS(Angle);     // 余弦
Result := TAN(Angle);     // 正切

// 其他数学函数
Result := SQRT(Value);    // 平方根
Result := ABS(Value);     // 绝对值
Result := LN(Value);      // 自然对数
Result := EXP(Value);     // e的幂

// 角度转弧度
Radian := Degree * 3.14159 / 180.0;
```

### 8.3 三菱数学函数

```
三菱FX系列数学函数：

【SIN正弦】
       X0
    ───┤├───────[SIN D0 D10]───
· D0：角度（0.001度单位，90000=90度）
· D10：结果（-1000~1000，对应-1~1）

【COS余弦】
       X0
    ───┤├───────[COS D0 D10]───

【TAN正切】
       X0
    ───┤├───────[TAN D0 D10]───

【SQRT平方根】
       X0
    ───┤├───────[DSQRT D0 D10]───
· D0：被开方数（32位）
· D10：结果
```

---

## 9. 数据类型转换

### 9.1 整数与实数转换

```
西门子类型转换：

【整数→实数】
              ┌──────────┐
   I0.0 ─────┤ INT_TO_  │
              │  REAL    │
   MW10 ─────┤IN    OUT ├───── MD20
              └──────────┘

【实数→整数】
              ┌──────────┐
   I0.0 ─────┤ REAL_TO_ │
              │  INT     │
   MD10 ─────┤IN    OUT ├───── MW20
              └──────────┘

【SCL程序】
RealValue := INT_TO_REAL(IntValue);
IntValue := REAL_TO_INT(RealValue);  // 四舍五入
IntValue := TRUNC(RealValue);         // 截断

【取整方式】
TRUNC : 截断（3.7→3，-3.7→-3）
ROUND : 四舍五入（3.5→4）
FLOOR : 向下取整（3.7→3，-3.2→-4）
CEIL  : 向上取整（3.2→4）
```

### 9.2 BCD与BIN转换

```
BCD码与二进制转换：

BCD（Binary Coded Decimal）：
· 每4位表示一个十进制数字
· 用于数码管显示

示例：
数值 1234
BIN: 0000 0100 1101 0010（0x04D2）
BCD: 0001 0010 0011 0100（0x1234）

三菱转换指令：
【BIN→BCD】
       X0
    ───┤├───────[BCD D0 K2Y0]───
· D0的值转为BCD输出到Y0-Y7（2位数码管）

【BCD→BIN】
       X0
    ───┤├───────[BIN K2X0 D0]───
· X0-X7的BCD输入转为BIN存入D0

西门子：
BCD_TO_INT : BCD转整数
INT_TO_BCD : 整数转BCD
```

---

## 10. 应用实例

### 10.1 温度换算（华氏↔摄氏）

```
公式：
°F = °C × 9/5 + 32
°C = (°F - 32) × 5/9

【摄氏转华氏】（整数运算避免小数）
// °F = °C × 9 / 5 + 32

       SM400
    ───┤├───────[MUL D0 K9 D10]───    // D10 = °C × 9
               [DIV D10 K5 D10]───    // D10 = D10 / 5
               [ADD D10 K32 D20]───   // D20 = D10 + 32

【浮点运算】（西门子SCL）
Fahrenheit := Celsius * 1.8 + 32.0;
Celsius := (Fahrenheit - 32.0) / 1.8;
```

### 10.2 流量计算

```
需求：根据流速和管径计算流量

公式：Q = π × r² × v × 3600
· Q：流量（m³/h）
· r：管道半径（m）
· v：流速（m/s）

SCL程序：
VAR
    Radius : REAL := 0.05;    // 50mm半径
    Velocity : REAL;          // 流速
    FlowRate : REAL;          // 流量
END_VAR

FlowRate := 3.14159 * Radius * Radius * Velocity * 3600.0;
```

### 10.3 平均值计算

```
需求：计算10个采样值的平均值

数据：D0-D9存储10个采样值
结果：D100存储平均值

三菱程序：
// 求和
       SM400
    ───┤├───────[MOV K0 D100]───        // 清零
               [ADD D0 D100 D100]───    // 累加D0
               [ADD D1 D100 D100]───    // 累加D1
               ...
               [ADD D9 D100 D100]───    // 累加D9
               [DIV D100 K10 D100]───   // 除以10

// 或使用FOR循环（西门子SCL）
Sum := 0;
FOR i := 0 TO 9 DO
    Sum := Sum + Sample[i];
END_FOR;
Average := Sum / 10;
```

### 10.4 PID增量计算

```
PID增量式算法：
Δu = Kp × (e(k) - e(k-1)) + Ki × e(k) + Kd × (e(k) - 2e(k-1) + e(k-2))

SCL实现：
VAR
    Error : ARRAY[0..2] OF REAL;  // 当前、上次、上上次误差
    Kp, Ki, Kd : REAL;            // PID参数
    DeltaU : REAL;                // 增量输出
END_VAR

// 比例项
P_term := Kp * (Error[0] - Error[1]);

// 积分项
I_term := Ki * Error[0];

// 微分项
D_term := Kd * (Error[0] - 2.0*Error[1] + Error[2]);

// 总输出
DeltaU := P_term + I_term + D_term;

// 误差移位
Error[2] := Error[1];
Error[1] := Error[0];
```

---

## 本节小结

```
数学运算指令要点：

┌────────────────────────────────────────────────────┐
│  基本运算                                          │
│  · ADD加法、SUB减法、MUL乘法、DIV除法            │
│  · 注意数据类型和溢出处理                         │
│  · 除法前检查除数不为零                           │
├────────────────────────────────────────────────────┤
│  特殊运算                                          │
│  · MOD取模：求余数                                │
│  · INC/DEC：递增/递减                             │
│  · NEG：取反                                      │
├────────────────────────────────────────────────────┤
│  数学函数                                          │
│  · 三角函数：SIN/COS/TAN（输入为弧度）           │
│  · 其他：SQRT/ABS/LN/EXP                         │
├────────────────────────────────────────────────────┤
│  类型转换                                          │
│  · INT↔REAL：整数与实数互转                      │
│  · BCD↔BIN：用于数码管显示                       │
└────────────────────────────────────────────────────┘
```

---

## 练习题

1. 编写程序计算两个16位整数的平均值。
2. 设计一个温度转换程序（摄氏转华氏）。
3. 如何避免除法运算时的除零错误？
4. 说明16位乘法结果为什么需要32位存储。

---

[返回目录](../README.md) | [下一节：4.2 移位与循环指令 →](./4.2_移位与循环指令.md)
